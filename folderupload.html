<html>
<head>
<title>upload test</title>
<script>
var globallog = ""
var pagelog;
function synclog()
{
    if(!pagelog)
	pagelog = document.getElementById("pagelog");
    pagelog.value = globallog;
	pagelog.scrollTop = pagelog.scrollHeight;
}

function writelog(text,sync)
{
    if(globallog.length > 32768)
        globallog = globallog.substring(16384);
    globallog += ""+text+"\n";
	if(sync)synclog();
    //document.getElementById("pagelog").innerText = log
}

</script>
</head>
<body onerror="writelog(event);synclog();">
<style>

html, body {
  height: 100%; }

html {
  background-color: #222; }

body {
  position: relative;
  /*max-width: 1024px;
  min-width: 768px;*/
  min-width: 600px;
  margin: 0 auto; }

header {
  color: #fff;
  background-color: #000;
  height: 24px;
  overflow: hidden; }

td {
  color: #fff;
  background-color: #000;
 }
.sidebar a:link {
color: #FFA;
}
.sidebar a:visited {
color: #FFC;
}


.sidebar, .main {

  -webkit-overflow-scrolling: touch;
  position: absolute;
  	top: 24px;
  bottom: 0; }

.sidebar {
  overflow:scroll;
  overflow-x:auto;
  width: 50%;
  background-color: #333;
  left: 0; }

.main {
  overflow: hidden;
  background-color: #f5f5f5;
  position: absolute;
  left: 50%;
  right: 0;
  padding: 20px;
  padding-bottom:25px; }

</style>
<header><div style="position:absolute;overflow:hidden" id="pathdisplay"></div><div style="position:absolute;right:0px;overflow:hidden">Dir:<input
      type="file"
      directory="directory"
      multiple
      webkitdirectory="webkitdirectory"
      id="files" size="4" style="font:40% sans-serif;"
    />File:
<input
      type="file"
      multiple
      id="file"  size="4" style="font:40% sans-serif"
    />Zip:<input type="file" id="zipfile" height="24px" width="40px"  size="4" style="font:40% sans-serif;"/>
<button id="mkdir" onclick="mkdirClick()">mkdir</button>
<button id="upload" disabled>Upload</button>

</div>
</header>
<div class="sidebar"><div id="filelist"></div></div>
<div class="main" id="uploadcontainer">	
<div id="dropcontainer" style="border:1px solid black;width:100%;height:75%;">Drop here</div><textarea id="pagelog"  style="width:100%;height:25%;resize:none;"></textarea>
</div>
<div id="editorcontainer" class="main" style="padding-bottom:40px;overflow:hidden;display:none">
<button onclick="saveEdit();">Save</button><button onclick="cancelEdit();">Cancel</button><br/>
<textarea id="editor" style="width:100%;height:100%;resize:none;"></textarea>
</div>	
</div>


<script>

// ie

function parseJSON(text)
{
	if("JSON" in window)
	{
		return JSON.parse(text);
	}
	else return eval("("+text+")");
}

function getXMLHttpRequest()
{
	var xhr = null;

	if(window.XMLHttpRequest)
		xhr = new XMLHttpRequest();
	else if(window.ActiveXObject) { // poor alternative, but at least filelist and editing works
		try {
			xhr = new ActiveXObject("Msxml2.XMLHTTP");
		} catch(e) {
			xhr = new ActiveXObject("Microsoft.XMLHTTP");
		}
	}
	else
		alert("Your browser doesn't support XMLHTTPRequest...");
	return xhr;
}

var XMLHttpRequest_DONE = 4


var dropContainer = document.getElementById("dropcontainer")
dropContainer.ondragover = dropContainer.ondragenter = function(event) {
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	if(event && event.preventDefault)
		event.preventDefault();
	if(event.dataTransfer)
		event.dataTransfer.dropEffect = 'copy';
	return false;
};
dropContainer.ondrop = function(event) {
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	if(event && event.preventDefault)
		event.preventDefault();
 	if('Promise' in window && event.dataTransfer && event.dataTransfer.items && event.dataTransfer.items[0].webkitGetAsEntry)
	{
		processDTItemsAsync(event.dataTransfer.items).then(function(files){
			processFiles(files);
		});
	}
	else
		processDTItems(event.dataTransfer);
	return false;
};

function resolveFile(resolve, item, path, fileList)
{
	item.file(function(file) {
		file.filepath = path + file.name; //save full path
		fileList.push(file);
		resolve(file);
	});
}

function resolveDir(resolve, item, path, fileList)
{
	var dirReader = item.createReader();
	dirReader.readEntries(function(entries){
		var entriesPromises = [];
		for (var i = 0; i < entries.length;i++)
			entriesPromises.push(traverseItems(entries[i], (path ? path :"") + item.name + "/", fileList));
		resolve(Promise.all(entriesPromises));
	});
}

function resolveItem(resolve, item, path, fileList)
{
	if (item.isFile)
		resolveFile(resolve, item, path, fileList);
	else if (item.isDirectory)
		resolveDir(resolve, item, path, fileList);
}

function traverseItems(item, path, fileList)
{
	return new Promise(function(resolve){
		resolveItem(resolve, item, path, fileList);
	});
}

function processDTItemsAsync(dataTransferItems) // do we ever need this???
{
	var files = [];
	return new Promise(function(resolve, reject){
	var entriesPromises = [];
		for (var i = 0; i < dataTransferItems.length;i++)
			entriesPromises.push(traverseItems(dataTransferItems[i].webkitGetAsEntry(), "", files));
		Promise.all(entriesPromises).then(function(entries){
			resolve(files);
		});
	});
}
function traverseFileTree(item, path) {
  path = path || "";
  if (item.isFile) {
    // Get file
    item.file(function(file) {
      file.filepath = path + file.name;
		selectedfiles.push(file);
		processFiles([]);
    });
  } else if (item.isDirectory) {
    // Get folder contents
    var dirReader = item.createReader();
    dirReader.readEntries(function(entries) {
      for (var i=0; i<entries.length; i++) {
        traverseFileTree(entries[i], path + item.name + "/");
      }
    });
  }
}
function processDTItems(dataTransfer)
{
	var items = dataTransfer.items;

	if(!items || !items[0].webkitGetAsEntry)
	{
		// this cannot handle folders at all
		processFiles(dataTransfer.files);
		return;
	}

	for (var i=0; i < items.length; i++) {
		// this handles folders and files in async way, we'll update file list on every file (slow)
		var item = dataTransfer.items[i].webkitGetAsEntry();
		traverseFileTree(item);
	}
}

var pendingfiles = [];
var selectedfiles = [];
var uploadingfiles = [];

var list_path = "";

function uploadFile(file)
{
	uploadingfiles.push(file);
	var req = getXMLHttpRequest();
	var path = (file.filepath|| file.webkitRelativePath || file.name);
	writelog("uploading:"+path);
	req.open("PUT", "/files/"+list_path+(list_path.length >0?"/":"")+path, true);
	req.onreadystatechange = function(){
		//writelog("readyState("+path+"):"+req.readyState);
		if (req.readyState === XMLHttpRequest_DONE) {
			var status = req.status;
			//writelog("status("+path+"):"+status);


			if ((status === 0 || (status >= 200 && status < 400)) && req.responseText == 'OK' ) {

			} else {
				pendingfiles.push(file);
				writelog("error:"+path, true);
			}
 			var index = uploadingfiles.indexOf(file);
			if(index >= 0)
			uploadingfiles.splice(index, 1);
			scheduleUpload();
		}
	}
	req.send(file)
}
var last_update = new Date();
function updateStatus()
{
	var now = new Date();
	if(now - last_update > 400)
	{
		last_update = now;
		var count = pendingfiles.length;
		var status = "Files left: " + count + "\nUploading now:\n" ;
		for(var i = 0; i < uploadingfiles.length; i++)
		{
			var file = uploadingfiles[i];
			status += (file.filepath|| file.webkitRelativePath|| file.name) + "\n";
		}
		dropContainer.innerText = status;
		synclog();
	}
}



function scheduleUpload()
{
	while(uploadingfiles.length < 16 && pendingfiles.length > 0)
	{
		uploadFile(pendingfiles.pop())
	}
	updateStatus();
	if(uploadingfiles.length == 0 && pendingfiles.length == 0)
	{
		alert("upload done!");
		resetSelection();
		updateList();
	}
}

function processFiles(files)
{
	/*for(var file of files)
		writelog(file.filepath|| file.webkitRelativePath);
	var req = new XMLHttpRequest();
	req.open("PUT", "/files/"+(file.filepath|| file.webkitRelativePath), true);
	console.log(file.size);
	req.send(file)
	synclog();*/
	if(pendingfiles.length)
		return;	
	if(selectedfiles.length)
		selectedfiles = Array.prototype.concat(selectedfiles,Array.prototype.slice.call(files))
	else if(files)
		selectedfiles = Array.prototype.slice.call(files);

	var len = selectedfiles.length;
	uploadButton.disabled = false;
	dropContainer.innerText = "" + len + " files selected, click \"Upload\" to start now!";
}

function startUpload()
{
	pendingfiles = selectedfiles;
	uploadButton.disabled = true;
	uploadButton.innerText = "Upload";
	if(oldFileList)
		fileListContainer.removeChild(oldFileList);
	oldFileList = null;
	scheduleUpload();
}

function resetSelection()
{
	dropContainer.innerText = "Drop here";
	selectedFiles = [];
}

function delfile(path)
{
	if(!confirm("Delete "+path))
		return;
	var req = getXMLHttpRequest();
	req.open("DELETE", path, true);
	req.onreadystatechange = function(){
		//writelog("readyState("+path+"):"+req.readyState);
		if (req.readyState === XMLHttpRequest.DONE) {
			updateList();
		}
	}
	req.send();
}
function folderWalk(name)
{
	if(list_path.length)
		list_path += '/';
	list_path += name;
	updateList();
}
function folderUp()
{
	var i = list_path.lastIndexOf('/');
	writelog(i, true);
	list_path = i >= 0?list_path.substring(0,i):"";
	updateList();
}

var oldFileList = null;
var fileListContainer = document.getElementById("filelist");
var pathDisplay = document.getElementById("pathdisplay");
var uploadButton = document.getElementById("upload");
var editorContainer = document.getElementById("editorcontainer");
var uploadContainer = document.getElementById("uploadcontainer");
function folderClick(event)
{
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	folderWalk(event.target.innerText);
}

function delClick(event)
{
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	delfile(event.target.data || event.srcElement.data);
}
var editpath = "";
function saveEdit()
{
	var text = document.getElementById("editor").value;
	writelog("Saving file: " + editpath, true);
	var req = getXMLHttpRequest();
	req.open("PUT", editpath, true);
	req.onreadystatechange = function(){
		writelog("readyState("+editpath+"):"+req.readyState);
		if (req.readyState === XMLHttpRequest_DONE) {
			var status = req.status;
			//writelog("status("+path+"):"+status);


			if ((status === 0 || (status >= 200 && status < 400)) && req.responseText == "OK") {
				editorContainer.style.display = 'none';
				uploadContainer.style.display = 'block';
			}
		}
		synclog();
	};
	if('Blob' in window)
		req.send(new Blob([text],{type:"text/plain"}));
	else
		req.send(text);
}

function editClick(event)
{
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;

	writelog("Editing file: " + event.target.data);
	synclog();
	editpath = event.target.data;
	var req = getXMLHttpRequest();
	req.open("GET", event.target.data, true);

	req.onreadystatechange = function(){
		writelog("readyState("+event.target.data+"):"+req.readyState);
		if (req.readyState === XMLHttpRequest_DONE) {
				var status = req.status;
			writelog("status():"+status);


			if ((status === 0 || (status >= 200 && status < 400)) && req.responseText.length > 0 && req.responseText.length < 65535) {
				document.getElementById("editor").value = req.responseText;
				editorContainer.style.display = 'block';
				uploadContainer.style.display = 'none';
			}
		}
		synclog();
	};
	req.send();
	//editorContainer.style.display = 'block';
	//uploadContainer.style.display = 'none';
}

function cancelEdit()
{
	editorContainer.style.display = 'none';
	uploadContainer.style.display = 'block';
}

function delDirClick(event)
{
}

function zipClick(event)
{
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	var a = document.createElement("a");
	a.href = event.target.data;
	a.appendChild(document.createTextNode("Download zip " + event.target.data));
	a.target = "_blank";
	dropContainer.appendChild(document.createElement("br"));
	dropContainer.appendChild(a);
}

function mkdirClick()
{
	var req = getXMLHttpRequest();
	var path= prompt("Folder name", "");
	req.open("MKCOL", "/files/"+list_path+(list_path.length >0?"/":"")+path+ "/", true);
	req.onreadystatechange = function(){
		if (req.readyState === XMLHttpRequest_DONE) {
				var status = req.status;
			writelog(status, true);
			if ((status === 0 || (status >= 200 && status < 400))) {
				updateList();
			}
		}
	}
	req.send();
}

function moveClick(event)
{
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	var newName = prompt("New filename", event.target.data);
	if(newName.indexOf("/") < 0)
		newName = "/files/"+list_path+(list_path.length >0?"/":"")+newName;
	var req = getXMLHttpRequest();
	req.open("MOVE", event.target.data, true);
	req.setRequestHeader("Destination", newName);
	req.onreadystatechange = function(){
		if (req.readyState === XMLHttpRequest_DONE) {
				var status = req.status;
			writelog(status, true);
			if ((status === 0 || (status >= 200 && status < 400))) {
				updateList();
			}
		}
	}
	req.send();
}

function updateList()
{
	if(oldFileList)
		fileListContainer.removeChild(oldFileList);
	oldFileList = null;
	var req = getXMLHttpRequest();
	if(list_path.length)
		pathDisplay.innerText = list_path;
	else
		pathDisplay.innerText = "(root)";
	writelog("Listing files: " + "/list/"+list_path, true);
	req.open("GET", "/list/"+list_path, true);
	req.onreadystatechange = function(){
		if (req.readyState === XMLHttpRequest_DONE) {
				var status = req.status;
			writelog("status("+list_path+"):"+status, true);
			try{

			if ((status === -1 || status === 0 || (status >= 200 && status < 400))) {
				var tbl = document.createElement("table");
				tbl.setAttribute("border", "2");
				var tbd = document.createElement("tbody");
				var row = document.createElement("tr");
				var cell = document.createElement("td");
				cell.width = "100%";
				if(list_path.length)
				{
					cell.appendChild(document.createTextNode(".."))
					cell.onclick = folderUp;
				}
				else
					cell.appendChild(document.createTextNode("(root)"));
				row.appendChild(cell);
				cell = document.createElement("td");
				cell.appendChild(document.createTextNode("<up>"));
				row.appendChild(cell);
				tbd.appendChild(row);

				//var str = "<a  onclick=\"folderUp();\">..</a><br>"
				var arr = parseJSON(req.responseText);
				for(var i = 0; i < arr.length; i++)
				{
					var item = arr[i];
					if(item.type == 1)
					{
						row = document.createElement("tr");
						cell = document.createElement("td");
						link = document.createElement("a");
						link.appendChild(document.createTextNode(item.name));
						link.href="/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.target="_blank";
						cell.appendChild(link)
						row.appendChild(cell);
						cell = document.createElement("td");
						cell.appendChild(document.createTextNode(item.size));
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.onclick = moveClick;
						link.appendChild(document.createTextNode("mv"));
						cell.appendChild(link);
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.onclick = delClick;
						link.appendChild(document.createTextNode("del"));
						cell.appendChild(link);
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						if(item.size < 65536)
							link.onclick = editClick;
						else
							link.disabled = true;
						link.appendChild(document.createTextNode("ed"));
						cell.appendChild(link);
						row.appendChild(cell);
						tbd.appendChild(row);
					}
					//str += "<a href=\"/files/"+list_path+(list_path.length >0?"/":"")+item.name+"\">"+item.name+" ("+item.size+")</a><a onclick=\"delfile('/files/"+list_path+(list_path.length >0?"/":"")+item.name+"')\">del</a><br>";
					else if(item.type == 0)
					{
						row = document.createElement("tr");
						cell = document.createElement("td");
						link = document.createElement("a");
						link.onclick = folderClick;
						link.appendChild(document.createTextNode(item.name));
						cell.appendChild(link);
						row.appendChild(cell);
						cell = document.createElement("td");
						cell.appendChild(document.createTextNode("<dir>"));
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.onclick = moveClick;
						link.appendChild(document.createTextNode("mv"));
						cell.appendChild(link);
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.onclick = delDirClick;
						link.appendChild(document.createTextNode("del"));
						cell.appendChild(link);
						row.appendChild(cell);
						cell = document.createElement("td");
						link = document.createElement("button");
						link.data = "/files/"+list_path+(list_path.length >0?"/":"")+item.name;
						link.onclick = zipClick;
						link.appendChild(document.createTextNode("zip"));
						cell.appendChild(link);
						row.appendChild(cell);
						tbd.appendChild(row);
					}
						//str += "<a onclick=\"folderWalk('"+item.name+"');\">"+item.name+"</a><br>";
				}
				tbl.appendChild(tbd);
				//document.getElementById("filelist").innerHTML=str;

				fileListContainer.appendChild(tbl);
				oldFileList = tbl;
				

			} else {
			}
			}catch(e){writelog(e, true);}
		}
	}
	req.send();
	
}
updateList();
document.getElementById("files").onchange = function(event) {
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	processFiles(event.target.files);
};
document.getElementById("file").onchange = function(event) {
	if(!event) event = window.event;
	if(!event.target)
		event.target = event.srcElement;
	processFiles(event.target.files);
};
document.getElementById("zipfile").onchange = function(event) {
	// TODO: zip
};
uploadButton.onclick = startUpload;
uploadButton.disabled = true;
</script>


</body>
</head>